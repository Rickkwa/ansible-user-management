
notifications:
  email: false

language: python

python: 3.6

env:
  - ANSIBLE_VER=2.5.2
  - ANSIBLE_VER=2.6.1

sudo: true

stages:
  - lint
  - test
  - non-functional-test

services:
  - docker

before_install:
  - docker-compose -f tests/docker-compose.yml build
  - sudo mkdir -p /etc/ansible/roles
  - sudo ln -s $TRAVIS_BUILD_DIR /etc/ansible/roles/user_management
  - sudo cp -f $TRAVIS_BUILD_DIR/tests/inventory /etc/ansible/hosts
  # Set host_key_checking = false
  - echo "W2RlZmF1bHRzXQ0KaG9zdF9rZXlfY2hlY2tpbmcgPSBmYWxzZQ==" | base64 -d > ~/.ansible.cfg

install:
  - sudo apt-get install sshpass
  - pip install ansible==$ANSIBLE_VER
  - pip install ansible-lint

script:
  - |
    for testcase in $(ls tests/cases/*.{yml,yaml}); do
      echo -e "\033[35m ===================================================== \033[0m"
      echo -e "\033[35m === $testcase \033[0m"
      echo -e "\033[35m ===================================================== \033[0m"
      docker-compose -f tests/docker-compose.yml up -d
      ansible-playbook tests/test-role.yml --extra-vars="test_case=$(basename ${testcase})" -v || exit 1
      docker-compose -f tests/docker-compose.yml down
    done

jobs:
  include:
    - stage: lint
      before_install: []
      script:
        - ansible-lint .
      allow_failures: true
      # TODO: Test it by purposely introducing a lint error

    # - stage: non-functional-test
    #   script:
    #     - docker-compose -f tests/docker-compose.yml up -d
    #     - ansible-playbook tests/test-role.yml --extra-vars="test_case=add-user-group.yml" --check

    # Idempotency test
    - stage: non-functional-test
      before_script:
        - docker-compose -f tests/docker-compose.yml up -d
        - ansible-playbook tests/test-idempotency.yml --extra-vars="action=add" > /dev/null
      script:
        - '! ansible-playbook tests/test-idempotency.yml --extra-vars="action=add" 1>&2 | grep "changed=" | grep -v "changed=0"'

    # Idempotency test
    - stage: non-functional-test
      before_script:
        - docker-compose -f tests/docker-compose.yml up -d
        - ansible-playbook tests/test-idempotency.yml --extra-vars="action=add" > /dev/null
        - ansible-playbook tests/test-idempotency.yml --extra-vars="action=remove" > /dev/null
      script:
        - '! ansible-playbook tests/test-idempotency.yml --extra-vars="action=remove" 1>&2 | grep "changed=" | grep -v "changed=0"'
